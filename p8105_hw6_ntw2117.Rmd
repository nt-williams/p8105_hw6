---
title: "Data Science Homework 6"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(modelr)

theme_set(theme_bw())
```

### Problem One

*importing and manipulating data* 

```{r importing and manipulating wp data, message = FALSE, warning = FALSE}
murder <- 
  read_csv("https://raw.githubusercontent.com/washingtonpost/data-homicides/master/homicide-data.csv")

murder <- murder %>%  
  unite("city_state", c("city", "state"), sep = ", ") %>% 
  mutate(solved = ifelse(disposition == "Closed by arrest", 1, 0), 
         victim_race = ifelse(victim_race != "White", "non-White", "White"), 
         victim_race = fct_relevel(victim_race, "White", "non-White"),
         victim_age = as.numeric(victim_age)) %>% 
  filter(!(city_state %in% c("Dallas, TX", "Phoenix, AZ", "Kansas City, MO", "Tulsa, AL")))
```

*Logit models*

```{r baltimore logit}
balt_model <- murder %>% 
  filter(city_state == "Baltimore, MD") %>% 
  glm(solved ~ victim_sex + victim_race + victim_age, family = binomial, data = .)

broom::tidy(balt_model) %>% 
  mutate(or = exp(estimate), 
         or_lower = exp(estimate - 1.96*std.error), 
         or_upper = exp(estimate + 1.96*std.error)) %>% 
  filter(term == "victim_racenon-White") %>% 
  select(or, or_lower, or_upper) %>% 
  rename("Odds ratio" = or, 
         "Lower bound" = or_lower, 
         "Upper bound" = or_upper) %>% 
  knitr::kable(digits = 3)
```

```{r out.width = "70%", fig.height = 8, fig.align = "center", dpi = 300}
murder %>% 
  group_by(city_state) %>% 
  nest() %>% 
  mutate(logit_solve = map(data, ~glm(solved ~ victim_sex + victim_race + victim_age, 
                                      family = binomial, data = .x)), 
         logit_solve = map(logit_solve, broom::tidy)) %>% 
  select(-data) %>% 
  unnest() %>% 
  filter(term == "victim_racenon-White") %>% 
  mutate(or = exp(estimate), 
         or_lower = exp(estimate - 1.96*std.error), 
         or_upper = exp(estimate + 1.96*std.error), 
         city_state = fct_reorder(city_state, estimate)) %>% 
  select(city_state, or, or_lower, or_upper) %>% 
  ggplot(aes(x = city_state, y = or)) + 
  geom_point() + 
  geom_errorbar(aes(ymin = or_lower, ymax = or_upper)) + 
  geom_hline(yintercept = 1.0, linetype = "dashed") + 
  coord_flip() + 
  labs(y = "Odds ratio", 
       x = "City, State")
```

### Problem Two

```{r message = FALSE}
bweight <- read_csv("data/birthweight.csv") %>% 
  janitor::clean_names()

# sum(is.na(bweight))
# equals 0, no missing data

corr <- list()

for (i in 1:ncol(bweight)) {
  corr[[i]] <- cor(bweight$bwt, bweight[i])
}

as.data.frame(corr) %>% 
  gather(key = var, value = correlation) %>% 
  filter(correlation > 0.2)

lm_mod <- bweight %>% 
  lm(bwt ~ bhead + blength + delwt + gaweeks + wtgain + mrace + frace + malform + babysex + menarche + smoken, data = .)

# adding menarche because I think this is what the low values are associated with

rmse(lm_mod, bweight)

bweight %>% 
  add_predictions(model = lm_mod) %>% 
  add_residuals(model = lm_mod) %>% 
  ggplot(aes(x = pred, y = resid)) + 
  geom_point() + 
  geom_smooth(se = FALSE)
  

cor(bweight$bwt, bweight$gaweeks)

bweight <- bweight %>% 
  mutate(babysex = as.factor(babysex), 
         frace = as.factor(frace), 
         malform = as.factor(malform), 
         mrace = as.factor(mrace))
```

```{r error = TRUE}
cv_bweight <- crossv_mc(bweight, 100)

# checking if any variables I don't think will be main predictors are signficant amongst themselves

cv_bweight %>% 
  mutate(lm_mod = map(train, ~lm(bwt ~ delwt + frace + menarche + mheight + momage + parity + wtgain, 
                                 data = .x)), 
         lm_mod = map(lm_mod, broom::tidy)) %>% 
  select(.id, lm_mod) %>% 
  unnest() %>% 
  group_by(term) %>% 
  summarize(avg_p = mean(p.value)) %>% 
  filter(avg_p < 0.05)

bweight %>% 
  lm(bwt ~ babysex + bhead + blength + delwt + fincome + frace + gaweeks + malform +
                                   mheight + mrace + parity + pnumlbw + ppbmi + ppwt + smoken + wtgain, data = .) %>% 

mods <- cv_bweight %>% 
  mutate(lm_mod = map(train, ~lm(bwt ~ babysex + gaweeks + malform + smoken, 
                                 data = .x))) %>% 
  mutate(pred = map2(test, lm_mod, add_predictions))
  select(.id)
  
cv_bweight <- cv_bweight %>% 
  mutate(lm_mod = map(train, ~lm(bwt ~ babysex + gaweeks + malform + smoken, 
                                 data = .x))) %>% 
  mutate(rmse_lm = map2_dbl(lm_mod, test, ~rmse(model = .x, data = .y)))

cv_bweight %>% 
  select(rmse_lm) %>% 
  gather(key = .id, value = rmse_lm) %>% 
  ggplot(aes(rmse_lm)) + 
  geom_density()
  
pred <- map2(mods$test, mods$lm_mod, add_predictions)
```

```{r}
choose <- c("delweight", "frace", "menarche", "mheight", "momage", "parity", "wtgain")

pmodels <- list()

varlist <- tibble(
  x = 1:7
)

take <- function(i) {
  as.tibble(combn(choose, i))
}

varlist <- varlist %>% 
  group_by(x) %>% 
  nest() %>% 
  mutate(vars = map(x, take))

```








